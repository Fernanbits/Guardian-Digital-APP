<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardían Digital</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo Guardián Digital">
            <span>Guardían Digital</span>
        </div>
        <button class="hamburger" id="hamburger-btn">&#9776;</button>
        <ul class="navbar-nav" id="navbar-menu">
            <li><a href="{{ url_for('index') }}">Inicio</a></li>
            <li><a href="{{ url_for('manage_personal') }}">Personal</a></li>
            <li><a href="{{ url_for('manage_equipment') }}">Equipos</a></li>
        </ul>
    </nav>

    <div class="page-content">
        <h1>Sistema Guardián Digital</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <div class="container">
            <h2>Registrar Salida de Equipo</h2>
            <form action="/registrar_salida" method="POST">
                <label for="equipo_id_salida">Seleccionar Equipo:</label>
                <select id="equipo_id_salida" name="equipo_id" required>
                    <option value="">-- Seleccione un equipo --</option>
                    {% for equipo in equipos %}
                        <option value="{{ equipo['Nombre Equipo'] }}">{{ equipo['Nombre Equipo'] }}</option>
                    {% endfor %}
                </select><br>

                <label for="personal_id_salida">Persona que Retira:</label>
                <select id="personal_id_salida" name="personal_id_salida" required>
                    <option value="">-- Seleccione una persona --</option>
                    {% for persona in personal %}
                        <option value="{{ persona['Nombre Responsable'] }}">{{ persona['Nombre Responsable'] }}</option>
                    {% endfor %}
                </select><br>

                <label for="nombre_usuario">Nombre de Usuario (quien usará el equipo):</label>
                <input type="text" id="nombre_usuario" name="nombre_usuario" required><br>

                <input type="submit" value="Registrar Salida">
            </form>
        </div>

        <div class="container filter-container">
            <h2>Buscar Registros</h2>
            <form action="{{ url_for('index') }}" method="GET" class="filter-form">
                <label for="responsable_filter">Filtrar por Responsable:</label>
                <input type="text" id="responsable_filter" name="responsable_filter" value="{{ responsable_filter or '' }}" placeholder="Nombre del responsable">

                <label for="pc_filter">Filtrar por PC:</label>
                <input type="text" id="pc_filter" name="pc_filter" value="{{ pc_filter or '' }}" placeholder="Ej. PC-01">
                
                <input type="submit" value="Aplicar Filtros">
                {% if responsable_filter or pc_filter %}
                    <a href="{{ url_for('index') }}" class="clear-filters-btn">Limpiar Filtros</a>
                {% endif %}
            </form>
        </div>

        <div class="container">
            <h2>Registros de Uso de Equipos</h2>
            <form action="/batch_update" method="POST" class="batch-update-form">
                <table>
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select_all_records"></th>
                            <th>ID Registro</th>
                            <th>Fecha y Hora Salida</th>
                            <th>Nombre Usuario</th>
                            <th>Nombre Equipo</th>
                            <th>ID Personal Salida</th>
                            <th>Fecha y Hora Devolución</th>
                            <th>ID Personal Devolución</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registro in registros %}
                        <tr>
                            <td>
                                {% if registro['Estado'] == 'Pendiente' %}
                                    <input type="checkbox" name="selected_records" value="{{ registro['ID Registro'] }}">
                                {% endif %}
                            </td>
                            <td data-label="ID Registro">{{ registro['ID Registro'] }}</td>
                            <td data-label="Fecha y Hora Salida">{{ registro['Fecha y Hora Salida'] }}</td>
                            <td data-label="Nombre Usuario">{{ registro['Nombre Usuario'] }}</td>
                            <td data-label="Nombre Equipo">{{ registro['Nombre Equipo'] }}</td>
                            <td data-label="ID Personal Salida">{{ registro['ID Personal Salida'] }}</td>
                            <td data-label="Fecha y Hora Devolución">{{ registro['Fecha y Hora Devolucion'] }}</td>
                            <td data-label="ID Personal Devolución">{{ registro['ID Personal Devolucion'] }}</td>
                            <td data-label="Estado">
                                <span class="status-badge status-{{ registro['Estado']|lower }}">
                                    {{ registro['Estado'] }}
                                </span>
                                </td>
                            <td data-label="Acciones">
                                {% if registro['Estado'] == 'Pendiente' %}
                                <form action="/registrar_devolucion" method="POST" class="inline-devolucion-form">
                                    <input type="hidden" name="registro_id" value="{{ registro['ID Registro'] }}">
                                    <select name="personal_id_devolucion" required>
                                        <option value="">-- Persona que recibe --</option>
                                        {% for persona in personal %}
                                            <option value="{{ persona['Nombre Responsable'] }}">{{ persona['Nombre Responsable'] }}</option>
                                        {% endfor %}
                                    </select>
                                    <input type="submit" value="Devolver">
                                </form>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="batch-actions">
                    <label for="batch_responsible_devolucion">Responsable para lote:</label>
                    <select name="batch_responsible_devolucion" id="batch_responsible_devolucion">
                        <option value="">-- Seleccione responsable --</option>
                        {% for persona in personal %}
                            <option value="{{ persona['Nombre Responsable'] }}">{{ persona['Nombre Responsable'] }}</option>
                        {% endfor %}
                    </select>

                    <select name="batch_action" id="batch_action" required>
                        <option value="">-- Seleccione acción --</option>
                        <option value="complete">Completar seleccionados</option>
                        </select>

                    <input type="submit" value="Realizar acción en lote">
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // JavaScript para seleccionar/deseleccionar todos los checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            const selectAllCheckbox = document.getElementById('select_all_records');
            const recordCheckboxes = document.querySelectorAll('input[name="selected_records"]');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const navbarMenu = document.getElementById('navbar-menu');

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    recordCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                });
            }

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', function() {
                    navbarMenu.classList.toggle('active');
                });
            }
        });
    </script>
</body>
</html>